name: Run Autotests Simplified

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-22.04  # Используем более стабильную версию
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        
        # Chrome уже установлен в ubuntu-22.04, просто проверяем
        google-chrome --version || echo "Chrome not found, installing..."
        
        # Установка ChromeDriver (упрощенная)
        wget -q https://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_linux64.zip
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
    
    - name: Install Python packages
      run: |
        pip install selenium fastapi uvicorn pytest python-multipart
    
    - name: Start server
      run: |
        echo "Starting server..."
        python -c "import subprocess; import sys; p = subprocess.Popen(['uvicorn', 'form:app', '--host', '127.0.0.1', '--port', '8000'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)"
        import time
        time.sleep(5)
    
    - name: Run tests
      run: |
        python test.py