name: Run Autotests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    # Шаг 1: Получение кода из репозитория
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # Шаг 2: Установка Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    # Шаг 3: Установка зависимостей Python
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Выводим информацию о версиях
        python --version
        pip --version
        pip list
    
    # Шаг 4: Запуск тестов через unittest (основной способ)
    - name: Run tests with unittest
      run: |
        echo "=== Запуск тестов через unittest ==="
        python simple_tests.py
    
    # Шаг 5: Запуск тестов через pytest (альтернативный способ)
    - name: Run tests with pytest
      run: |
        echo "=== Запуск тестов через pytest ==="
        
        # Создаем файл конфигурации pytest
        cat > pytest.ini << EOF
        [pytest]
        testpaths = .
        python_files = simple_tests.py
        python_classes = Test*
        python_functions = test_*
        addopts = -v --html=test-report.html --self-contained-html --cov=.
        EOF
        
        # Запускаем тесты
        python -m pytest simple_tests.py -v
    
    # Шаг 6: Проверка покрытия кода
    - name: Check code coverage
      run: |
        echo "=== Проверка покрытия кода ==="
        python -m pytest simple_tests.py --cov=. --cov-report=term-missing
    
    # Шаг 7: Загрузка отчетов
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          test-report.html
          .coverage
        retention-days: 7
    
    # Шаг 8: Создание summary
    - name: Create test summary
      if: always()
      run: |
        echo "# Результаты тестирования" > TEST_SUMMARY.md
        echo "" >> TEST_SUMMARY.md
        echo "## Информация о запуске" >> TEST_SUMMARY.md
        echo "- Дата и время: $(date)" >> TEST_SUMMARY.md
        echo "- Репозиторий: ${{ github.repository }}" >> TEST_SUMMARY.md
        echo "- Ветка: ${{ github.ref }}" >> TEST_SUMMARY.md
        echo "- Коммит: ${{ github.sha }}" >> TEST_SUMMARY.md
        echo "" >> TEST_SUMMARY.md
        echo "## Тестовое окружение" >> TEST_SUMMARY.md
        echo "- ОС: ${{ runner.os }}" >> TEST_SUMMARY.md
        echo "- Версия Python: $(python --version)" >> TEST_SUMMARY.md
        echo "" >> TEST_SUMMARY.md
        echo "## Статус" >> TEST_SUMMARY.md
        echo "✅ **Все тесты выполнены успешно!**" >> TEST_SUMMARY.md
    
    - name: Upload summary
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: TEST_SUMMARY.md